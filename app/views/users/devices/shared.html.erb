<% content_for :outside_container do %>
<%= Gon::Base.render_data %>
  <div id="map"></div>
  <style>
    #map {
      position:absolute;
      top:64px;
      bottom:0px;
      width:100%;
    }

    .popup-label {
      text-align: right;
      font-weight: bold;
    }

    .popup-value {
      text-align: left;
    }

    .popup-column {
      vertical-align: top;
      display: inline-block;
    }

    .address {
      white-space: pre;
    }

    .leaflet-popup-content img {
      margin-top: -10px;
    }
  </style>
  <script id="nullPopupTemplate" type="x-tmpl-mustache">
    {{ &avatar }}
    <div>{{ name }} has no visible location yet</div>
  </script>
  <script id="fullPopupTemplate" type="x-tmpl-mustache">
    {{ &avatar }}
    <h3>{{ friend }}'s last reported location</h3>
    <div class="center">
      <div class="popup-column">
        <div class="popup-label">Device:</div>
        <div class="popup-label">Created on:</div>
        <div class="popup-label">Latitude:</div>
        <div class="popup-label">Longitude:</div>
        <div class="popup-label">Address:</div>
      </div>
      <div class="popup-column">
        <div class="popup-value">{{ device.name }}</div>
        <div class="popup-value">{{ created_at }}</div>
        <div class="popup-value">{{ lat }}</div>
        <div class="popup-value">{{ lng }}</div>
        <div class="popup-value address">{{ address }}</div>
      </div>
    </div>
  </script>

  <script>
    COPO.maps.initMap()
    COPO.maps.initControls();
    var checkin = gon.checkin

    if(!checkin) {
      var friend = {
        name: COPO.utility.friendsName(gon.user),
        avatar: $.cloudinary.image(gon.user.avatar.public_id, {width: 60, height: 60, crop: 'fill', radius: 'max', gravity: 'face', class: 'left'}).prop('outerHTML')
       }
      var template = $('#nullPopupTemplate').html();
      var rendered = Mustache.render(template, friend);


      var popup = L.popup()
        .setLatLng(new L.latLng([51.5073509, -0.1277583])) //hardcoded latlng for London
        .setContent(rendered)
        .openOn(map);
      map.on('ready', function(){
        map.panTo(popup.getLatLng());
      })
    } else {

      checkin.avatar = $.cloudinary.image(gon.user.avatar.public_id, {width: 60, height: 60, crop: 'fill', radius: 'max', gravity: 'face', class: 'left'}).prop('outerHTML')
      checkin.created_at = new Date(checkin.created_at).toUTCString();
      checkin.address = checkin.address.replace(/, /g, '\n');
      checkin.device = gon.device;
      checkin.friend = COPO.utility.friendsName(gon.user);

      var template = $('#fullPopupTemplate').html();
      var rendered = Mustache.render(template, checkin);

      map.setView([checkin.lat, checkin.lng], 12)
      marker = L.marker([checkin.lat, checkin.lng], {
        icon: L.mapbox.marker.icon({
          'marker-size': 'large',
          'marker-symbol': 'heliport',
          'marker-color': '#ff6900',
        })
      })
      .bindPopup(rendered)
      .addTo(map);

      marker.openPopup();

      coords = {
        latlng: new L.latLng([checkin.lat, checkin.lng])
      }
      COPO.maps.w3w.setCoordinates(coords);
    }

  </script>
<% end %>
