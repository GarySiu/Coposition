<h3>Your current devices are:</h3><br>
<div class="collection">
  <% @devices.each do |device| %>
    <%= render device %>
  <% end %>
</div>

<div class="row">
  <div class="col m3 offset-m2">
    <%= link_to("Add new device", new_user_device_path, class: "btn btn-primary btn-lg") %>
  </div>

  <div class="col m3 offset-m2">
    <%= link_to("Add current device", add_current_user_devices_path, class: "btn btn-primary btn-lg") %>
  </div>
</div>

<script>
var current_user_id =  <%= @current_user_id %>;
var permissions_path = "<%= user_permissions_path%>";

function update_radios(data){
  $.each( data, function( index, permission ){
    var permission_id = permission.id;
    var priv = permission.privilege;
    $('input[data-permission="'+permission_id+'"][data-privilege="'+priv+'"]').prop('checked', true);
  });
}

function get_permissions(){ 
  $.ajax({
    url: permissions_path
  }).done(function(data) {
    update_radios(data);
  });
}

function update_permission(permission, device_id, privilege){
  $.ajax({
    url: "/users/"+current_user_id+"/devices/"+device_id+"/permissions/"+permission+"",
    type: 'PUT',
    data: { permission : { privilege: privilege } },
  }).done(function() {
    get_permissions();
  });
}

function radio_click() {
  $(".privilege-label").on( "click", function( event ) {
    var dataset = event.target.dataset
    var permission = dataset['permission'];
    var device_id = dataset['device'];
    var privilege = dataset['privilege'];
    update_permission(permission, device_id, privilege)
  });
}
get_permissions();
radio_click();
</script>