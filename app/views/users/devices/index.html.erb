<h3>Your current devices are:</h3><br>
<div class="collection">
  <% @devices.each do |device| %>
    <%= render device %>
  <% end %>
</div>

<div class="row">
  <div class="col m3 offset-m2">
    <%= link_to("Add new device", new_user_device_path, class: "btn btn-primary btn-lg") %>
  </div>

  <div class="col m3 offset-m2">
    <%= link_to("Add current device", add_current_user_devices_path, class: "btn btn-primary btn-lg") %>
  </div>
</div>

<script>
var current_user_id =  <%= @current_user_id %>;
var permissions_path = "<%= user_permissions_path%>";

function update_controls(data){
  $.each( data, function( index, permission ){
    var permission_id = permission.id;
    var priv = permission.privilege;
    var bypass_fogging = permission.bypass_fogging;
    var show_history = permission.show_history;
    $('li[data-permission="'+permission_id+'"]>div.bf>label>input').prop('checked', bypass_fogging);
    $('li[data-permission="'+permission_id+'"]>div.sh>label>input').prop('checked', show_history);
    $('li[data-permission="'+permission_id+'"]>div.input-field>div.select-wrapper> select').val(priv);
    $('select').material_select();
  });
}

function get_permissions(){ 
  $.ajax({
    url: permissions_path
  }).done(function(data) {
    update_controls(data);
  });
}

function update_permission(permission, device_id, attribute, value){
  if (attribute == 'privilege'){
    var data = { permission : { privilege: value } }
  } else if (attribute == 'bypass_fogging'){
    var data = { permission : { bypass_fogging: value } }
  } else {
    var data = { permission : { show_history: value } }
  }
  $.ajax({
    url: "/users/"+current_user_id+"/devices/"+device_id+"/permissions/"+permission+"",
    type: 'PUT',
    data: data,
  }).done(function() {
    get_permissions();
  });
}

function select_click() {
  $(".privilege").change(function( event ) {
    var privilege = $(this).find(':selected').val();
    var permission = $(event.target).parents('li.collection-item').data().permission;
    var device_id = $(event.target).parents('ul.collection').data().device;
    update_permission(permission, device_id, 'privilege', privilege)
  });
}

function toggle_click(){
  $(".switch").change(function( event ) {
    var state = $(event.target).prop('checked');
    var permission = $(event.target).parents('li.collection-item').data().permission;
    var device_id = $(event.target).parents('ul.collection').data().device;
    var attribute = $(this).attr('name');
    update_permission(permission, device_id, attribute, state)
  });
}

select_click();
toggle_click();
</script>