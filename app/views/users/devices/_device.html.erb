<div class="list-group-item">
  <a id="<%= device.name %>" href="<%= user_device_path(current_user.url_id, device) %>" class="list-group-item">
    <h4 class="list-group-item-heading"><%= device.name %></h4>
    <% if device.checkins.exists? %>
      <p class="list-group-item-text">Last reported in <%= device.checkins.last.address%> </p>
    <% else %>
      <p class="list-group-item-text">No checkins found </p>
    <% end %>
    <% if device.fogged %>
      <p class="list-group-item-text">Fogging is enabled on this device.</p>
    <% end %>
    <% if device.delayed %>
      <p class="list-group-item-text">Timeshifted with a delay of <%= "#{device.delayed.to_s+' minutes'}"%></p>
    <% end %>
    
  </a>
  <div class="row pt-m">
    <ul class="collapsible">
      <li>
        <div class="collapsible-header">Permissions </div>
        <div class="collapsible-body">
          <ul class="collapsible">
            <% device.developers.each do |developer| %>
              <li>
                <div class="collapsible-header"><%= developer.company_name%> </div>
                <div class="collapsible-body">
                  <form action="#">
                    <p>
                      <input name="privilege" type="radio" id="<%="#{device.id}_#{developer.id}"%>_complete" />
                      <label for="complete" class="radio_button" id="<%="#{device.id}_#{developer.id}"%>_complete">Complete</label>
                    </p>
                    <p>
                      <input name="privilege" type="radio" id="<%="#{device.id}_#{developer.id}"%>_limited" />
                      <label for="limited" class="radio_button" id="<%="#{device.id}_#{developer.id}"%>_limited">Limited</label>
                    </p>
                    <p>
                      <input name="privilege" type="radio" id="<%="#{device.id}_#{developer.id}"%>_disallowed" />
                      <label for="disallowed" class="radio_button" id="<%="#{device.id}_#{developer.id}"%>_disallowed">Disallowed</label>
                    </p>
                  </form>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </li>
    </ul>
  </div>
</div>
<script>
var current_user_id =  <%= @current_user_id %>

function update_radios(data){
  $.each( data, function( index, value ){
    var id = value.device_id+"_"+value.permissible_id;
    $("#"+id+"_"+value.privilege).prop('checked', true);
  });
}

function get_permissions(){ 
  $.ajax({
    url: "/users/"+current_user_id+"/devices/permissions",
    context: document.body
  }).done(function(data) {
    update_radios(data);
  });
}

function update_permission(device_id, developer_id, privilege){
  $.ajax({
    url: "/users/"+current_user_id+"/devices/"+device_id+"/switch_privilege",
    type: 'POST',
    data: { developer: developer_id, privilege: privilege },
  }).done(function(data) {
    get_permissions();
  });
}

function radio_click() {
  $(".radio_button").on( "click", function( event ) {
    $('input[type="radio"]').prop('checked', false);
    var id_array = event.target.id.split('_');
    var device_id = id_array[0];
    var developer_id = id_array[1];
    var privilege = id_array[2];
    update_permission(device_id, developer_id, privilege)
  });
}
get_permissions();
radio_click();
</script>