<div class="collection-item">
  <a id="<%= device.name %>" href="<%= user_device_path(current_user.url_id, device) %>">
    <h4 class="list-group-item-heading"><%= device.name %></h4>
    <% if device.checkins.exists? %>
      <p class="list-group-item-text">Last reported in <%= device.checkins.last.address%> </p>
    <% else %>
      <p class="list-group-item-text">No checkins found </p>
    <% end %>
    <% if device.fogged %>
      <p class="list-group-item-text">Fogging is enabled on this device.</p>
    <% end %>
    <% if device.delayed %>
      <p class="list-group-item-text">Timeshifted with a delay of <%= "#{device.delayed.to_s+' minutes'}"%></p>
    <% end %>
  </a>

  <% if device.developers.exists? %>
    <ul class="collapsible" data-collapsible="expandable">
      <% device.developers.each do |developer| %>
        <% permission_id =  device.permissions.where(permissible: developer, permissible_type: 'Developer').first.id %>
        <li>
          <div class="collapsible-header">
            <div class="valign-wrapper">
              <%= image_tag(developer.logo.url(:thumb), alt: "", class: "circle icon") %>
              <%= developer.company_name %>
            </div>
          </div>
          <div class="collapsible-body">
            <form action="#">
              <p>
                <input name="privilege" type="radio"
                 data-permission='<%= permission_id %>'
                 data-privilege='complete' />
                <label for="complete" class="privilege-label"
                 data-permission='<%= permission_id %>'
                 data-device='<%= device.id %>'
                 data-privilege='complete' >Complete</label>
              </p>
              <p>
                <input name="privilege" type="radio"
                data-permission='<%= permission_id %>'
                data-privilege='limited' />
                <label for="limited" class="privilege-label"
                data-permission='<%= permission_id %>'
                data-device='<%= device.id %>'
                data-privilege='limited' >Limited</label>
              </p>
              <p>
                <input name="privilege" type="radio"
                data-permission='<%= permission_id %>'
                data-privilege='disallowed' />
                <label for="disallowed" class="privilege-label"
                data-permission='<%= permission_id %>'
                data-device='<%= device.id %>'
                data-privilege='disallowed' >Disallowed</label>
              </p>
            </form>
          </div>
        </li>
      <% end %>

      <% device.permitted_users.each do |user| %>
        <% permission_id =  device.permissions.where(permissible: user, permissible_type: 'User').first.id %>
        <li>
          <div class="collapsible-header"><%= user.email%> </div>
          <div class="collapsible-body">
            <form action="#">
              <p>
                <input name="privilege" type="radio"
                data-permission='<%= permission_id %>'
                data-privilege='complete' />
                <label for="complete" class="privilege-label"
                data-permission='<%= permission_id %>'
                data-device='<%= device.id %>'
                data-privilege='complete' >Complete</label>
              </p>
              <p>
                <input name="privilege" type="radio"
                data-permission='<%= permission_id %>'
                data-privilege='limited' />
                <label for="limited" class="privilege-label"
                data-permission='<%= permission_id %>'
                data-device='<%= device.id %>'
                data-privilege='limited' >Limited</label>
              </p>
              <p>
                <input name="privilege" type="radio"
                data-permission='<%= permission_id %>'
                data-privilege='disallowed' />
                <label for="disallowed" class="privilege-label"
                data-permission='<%= permission_id %>'
                data-device='<%= device.id %>'
                data-privilege='disallowed' >Disallowed</label>
              </p>
            </form>
          </div>
        </li>
      <% end %>
    </ul>
  <% end %>
</div>
